// app.js - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† API Key

// âŒ Ø§Ø­Ø°Ù Ù‡Ø§Ù„Ø³Ø·Ø± ØªÙ…Ø§Ù…Ø§Ù‹ - Ù…Ø§ ÙÙŠ Ø¯Ø§Ø¹ÙŠ Ù„Ù„Ù€ API Key Ù‡ÙˆÙ†
// const OPENAI_API_KEY = '...' // Ø§Ø­Ø°ÙÙ‡!

let conversations = [];
let currentConversationId = null;
let isProcessing = false;
let isSecretMode = false;
let mediaRecorder;
let audioChunks = [];

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.getElementById('welcomeScreen').style.display = 'none';
    }, 4000);
    
    alternateTitle();
    initTheme();
    setupTabs();
    setupEventListeners();
    loadConversations();
    
    if (conversations.length === 0) {
        createNewConversation();
    } else {
        loadConversation(conversations[0].id);
    }
});

// ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø­ØªÙ‰ handleSendMessage)

async function handleSendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message || isProcessing) return;

    isProcessing = true;
    addUserMessage(message);
    input.value = '';

    const container = document.getElementById('messages-container');
    const indicator = document.createElement('div');
    indicator.id = 'typing-indicator';
    indicator.className = 'message-bubble ai-message p-4 max-w-3xl mx-auto';
    indicator.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div class="flex space-x-1">
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
            </div>
        </div>
    `;
    container.appendChild(indicator);

    // Custom responses
    const lowerMsg = message.toLowerCase();
    
    if (lowerMsg.includes('Ø´Ùˆ Ø§Ø³Ù…Ùƒ') || lowerMsg.includes('Ù…Ø§ Ø§Ø³Ù…Ùƒ') || lowerMsg.includes('Ø§Ø³Ù…Ùƒ')) {
        indicator.remove();
        addAIMessage("Ø§Ø³Ù…ÙŠ AI robotic ship");
        isProcessing = false;
        return;
    }

    if (lowerMsg.includes('Ù…Ù† ØµÙ†Ø¹Ùƒ') || lowerMsg.includes('Ù…ÙŠÙ† ØµÙ†Ø¹Ùƒ')) {
        indicator.remove();
        addAIMessage("ØµÙ†Ø¹Ù†ÙŠ Ø§Ù„Ø¯ÙƒØªÙˆØ± ØºÙŠØ§Ø« Ù…Ø­Ù…Ø¯ ØºÙŠØ«Ø§Ù† Ø´Ø§ÙƒØ±");
        isProcessing = false;
        return;
    }

    if (lowerMsg.includes('Ù…Ù† ØºÙŠØ§Ø«') || lowerMsg.includes('man howa ghiath')) {
        indicator.remove();
        addAIMessage("ØºÙŠØ§Ø« Ø´Ø§ÙƒØ± Ù‡Ùˆ Ø£ØµØºØ± Ù…Ø¨Ø±Ù…Ø¬ AI ÙÙŠ Ù…ØµØ±. Ø¹ÙØ±Ù ØºÙŠØ§Ø« Ø¨Ù‚Ø¯Ø±ØªÙ‡ Ø§Ù„Ø±Ø§Ø¦Ø¹Ø© Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ù…Ù† Ø¹Ù…Ø± 10 Ø³Ù†ÙˆØ§ØªÙØŒ ÙˆÙŠØ¨Ù„Øº Ø§Ù„Ø¢Ù† Ù…Ù† Ø§Ù„Ø¹Ù…Ø± 18 Ø¹Ø§Ù…Ø§Ù‹. Ù„Ù… ÙŠØ¯Ø®Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø¹Ø¯ØŒ Ù„ÙƒÙ†Ù‡ ÙŠÙ…ØªÙ„Ùƒ Ø®Ø¨Ø±Ø© Ø¨Ø±ÙˆÙÙŠØ³ÙˆØ± ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙÙŠ Ù…Ø¬Ø§Ù„ Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ.");
        isProcessing = false;
        return;
    }

    try {
        const conv = conversations.find(c => c.id === currentConversationId);
        const history = conv && conv.messages ? conv.messages.map(msg => ({
            role: msg.role === 'assistant' ? 'assistant' : msg.role,
            content: msg.content
        })) : [];

        // ğŸ”¥ Ø§Ù„Ø­Ù„: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Serverless Function Ø¨Ø¯Ù„ API Ù…Ø¨Ø§Ø´Ø±
        const apiUrl = window.location.hostname === 'localhost' 
            ? '/.netlify/functions/chat'  // Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
            : '/.netlify/functions/chat';  // Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Netlify

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: history
            })
        });

        const data = await response.json();
        indicator.remove();
        
        if (data.error) {
            throw new Error(data.error.message || data.error);
        }
        
        const aiText = data.choices[0].message.content;
        addAIMessage(aiText);
    } catch (error) {
        indicator.remove();
        addAIMessage('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }

    isProcessing = false;
}

async function handleCodeSendMessage() {
    const input = document.getElementById('code-message-input');
    const message = input.value.trim();
    if (!message || isProcessing) return;

    isProcessing = true;
    
    const container = document.getElementById('code-messages-container');
    const userDiv = document.createElement('div');
    userDiv.className = 'message-bubble user-message p-4 max-w-3xl mx-auto';
    userDiv.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-primary-600 flex items-center justify-center">
                <i class="fas fa-user text-white"></i>
            </div>
            <div class="flex-1">${escapeHtml(message)}</div>
        </div>
    `;
    container.appendChild(userDiv);
    input.value = '';

    const indicator = document.createElement('div');
    indicator.id = 'code-typing-indicator';
    indicator.className = 'message-bubble ai-message p-4 max-w-3xl mx-auto';
    indicator.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div class="flex space-x-1">
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
            </div>
        </div>
    `;
    container.appendChild(indicator);

    try {
        const apiUrl = '/.netlify/functions/chat';

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messages: [
                    { role: 'system', content: 'You are a helpful coding assistant. Provide code examples when asked. Format code with ```language syntax.' },
                    { role: 'user', content: message }
                ]
            })
        });

        const data = await response.json();
        indicator.remove();
        
        if (data.error) {
            throw new Error(data.error.message || data.error);
        }
        
        const aiText = data.choices[0].message.content;
        
        const aiDiv = document.createElement('div');
        aiDiv.className = 'message-bubble ai-message p-4 max-w-3xl mx-auto';
        aiDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div class="flex-1">${formatMessage(aiText)}</div>
            </div>
        `;
        container.appendChild(aiDiv);
        
        const codeMatch = aiText.match(/```[\s\S]*?\n([\s\S]*?)```/);
        if (codeMatch) {
            document.getElementById('code-preview').value = codeMatch[1].trim();
        }
    } catch (error) {
        indicator.remove();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message-bubble ai-message p-4 max-w-3xl mx-auto';
        errorDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div class="flex-1">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</div>
            </div>
        `;
        container.appendChild(errorDiv);
    }

    isProcessing = false;
}

// ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
// Ù†Ø³Ø® ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠØ© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ